<html>
<meta charset="UTF-8">
<head>
    <title>VM List - Tortilla Project</title>

    <style>
        table, th, td {
            border: 1px solid black;
            padding: 15px;
            text-align: left;
            border-collapse: collapse;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.0/jquery.contextMenu.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.0/jquery.contextMenu.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.0/jquery.ui.position.js"></script>
    <script src="config.js"></script>
    <script src="functions.js"></script>
    
    <!-- Check if user logged in -->
    <script> if (getCookie("sesskey") === undefined) { window.location.replace('/login'); }</script>

    <script>
        // context menu block
        $(function() {
            $.contextMenu({
                selector: '.context-menu-one',
                hideOnSecondTrigger: true,
                callback: contextMenuCallback,
                items: {
                    "console": {name: "Console"},
                    "start": {name: "Start"},
                    "save": {name: "Save"},
                    "shutdown": {name: "Shut Down"},
                    "poweroff": {name: "Power Off"}
                }
            });   
        });

        function contextMenuCallback(key, opt) {
            var action = key;
            var vmid = opt.$trigger.attr("vmid");
            var vmprovider = opt.$trigger.attr("vmprovider");

            if (action == "console") {
                var win = window.open("connect?vmid=" + vmid, '_blank');
                win.focus();
            } else {
                httpRequestAsync(
                    config.controllerUrl + config.controllerBaseAPI + "vm",
                    "POST",
                    {
                        "Content-Type": "application/json"
                    },
                    JSON.stringify(
                    {
                        "vmid": vmid,
                        "action": action,
                        "vmprovider": vmprovider
                    }),
                    commandSendCallback
                );
            }
        }

        function commandSendCallback(status, text) {
            if (status != 204) {
                var data = JSON.parse(text);
                alert(data['human_reason']);
            } else {
                // refresh vm data
                window.setTimeout(getVMList(config.controllerUrl + config.controllerBaseAPI, addVMsToTable, errorGetVM), 10000);
            }
        }
    </script>
    
</head>
<body>

<div style="text-align: center"><h1>Список виртуальных машин</h1></div>
<div style="text-align: center" id="loadingStatus">Загружается...</div>
<br>

<div style="width:70%; margin:0 auto;">
    <a href="/logout">Logout</a>
    <br>
    <table id="vmlist">
        <thead>
            <tr>
                <th style="width: 20%;">VM name</th>
                <th style="width: 20%;">VM status</th>
                <th style="width: 40%;">Most recent task</th>
                <th style="width: 20%;">Most recent task status</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script type="text/javascript">
    //get VMs block

    //get vms
    getVMList(config.controllerUrl + config.controllerBaseAPI, addVMsToTable, errorGetVM);

    function addVMsToTable(VMArray) {
        function addRowToVMList(name, status, task, taskStatus, vmid, vmprovider) {
            var tableRef = document.getElementById('vmlist').getElementsByTagName('tbody')[0];
            var newRow = tableRef.insertRow(tableRef.rows.length);

            //create connection string
            var url = 'connect?vmid=' + vmid;

            //insert values
            var nameCell  = newRow.insertCell(0);
            var namespan = document.createElement("span");
            namespan.setAttribute("class", "context-menu-one btn btn-neutral");
            namespan.setAttribute("vmid", vmid);
            namespan.setAttribute("vmprovider", vmprovider);
            namespan.textContent = name;
            var href = document.createElement("a");
            href.setAttribute("target", "_blank");
            href.setAttribute('href', url);
            href.appendChild(namespan);
            nameCell.appendChild(href);
            
            var statusCell = newRow.insertCell(1);
            var statustxt  = document.createTextNode(status);
            statusCell.appendChild(statustxt);

            var taskCell = newRow.insertCell(2);
            var tasktxt  = document.createTextNode(task);
            taskCell.appendChild(tasktxt);

            var taskStatusCell = newRow.insertCell(3);
            var taskstatustxt  = document.createTextNode(taskStatus);
            taskStatusCell.appendChild(taskstatustxt);
        }

        //add vms to table
        for (var i = 0; i < VMArray.length; i++) {
            addRowToVMList(
                VMArray[i]["name"],
                VMArray[i]["status"],
                VMArray[i]["task"],
                VMArray[i]["taskStatus"],
                VMArray[i]["vmid"],
                VMArray[i]["vmprovider"]
            )
        }

        //change status to "loaded"
        document.getElementById("loadingStatus").innerHTML = "Загружено";
    }

    function errorGetVM(reason, humanReason) {
        if (reason == "unauthenticated") {
            alert("Your session expired or you was not properly authenticated. Redirecting to login page...");
            window.location.replace('/logout');
        } else if (reason == "unauthorized") {
            // TODO: change from alert to something normal
            alert("You don't have permissions to this resource");
        } else {
            alert(humanReason);
        }
    }
</script>

</body>
</html>