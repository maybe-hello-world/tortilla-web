<html>
<head>
    <meta charset="UTF-8">
    <title>Login page - Tortilla Project</title>
    <script src="functions.js"></script>
    <script src="config.js"></script>
    <script src="NTLM/des.js"></script>
    <script src="NTLM/md4.js"></script>
    <script src="NTLM/hashgen.js"></script>
    <script>
        if (getCookie("sesskey") !== undefined) {
            window.location.replace('/');
        }

        let isClicked = false;
    </script>
</head>
<body>
<div>
    <form action="javascript://" onsubmit="sendForm()">
        <h2>Please Login</h2>
        <label id="result"></label><br>
        <label for="username">Username</label>
        <input id="username" name="username"/>
        <label for="password">Password</label>
        <input type="password" id="password" name="password"/>
        
        <div>
            <button id="login_button">Log in</button>
        </div>
    </form>
</div>

<script>
    function sendForm(){
        // double click
        if (isClicked) {
            console.log("already clicked");
            return true;
        }
        isClicked = true;

        //get domain and username from field
        var userfield = document.getElementsByName("username")[0].value;
        var password = document.getElementsByName("password")[0].value;

		//get userkey and save
        var userkey = "";
        
        var possible = "abcdefghijklmnopqrstuvwxyz0123456789";
        for (var i = 0; i < password.length; i++) {
            userkey += possible.charAt(Math.floor(Math.random() * possible.length));
        }

        //generate serverkey
        var serverkey = "";
        for (i = 0; i < password.length; i++) {
            serverkey += String.fromCharCode(password.charCodeAt(i) ^ userkey.charCodeAt(i));
        }
        serverkey = btoa(serverkey);
        userkey = btoa(userkey);
        localStorage.setItem("userkey", userkey);

        //change password to hash from password
        var hashes = calculateHash(password);
        password = hashes[0] + ":" + hashes[1];


        function onAnswer(status, text) {
            let answer;
            try {
                answer = JSON.parse(text);
            } catch (e) {
                console.log("Status: " + status);
                console.log("Text: " + text);
                return;
            }

            if (status === 200) {
                // set something to green to visualize successfull login
                document.getElementById("result").innerHTML = "Success!";

                // wait a second and redirect to main page
                window.setTimeout(function() {window.location.replace('/');}, 1000)
                
            } else {
                console.log(text);
                document.getElementById("result").innerHTML = "Error! " + answer['human_reason'];
            }
        }


        // send POST to api
        httpRequestAsync(
            config.controllerUrl + config.controllerBaseAPI + "login",
            "POST",
            {
                'Content-Type': 'application/json'
            },
            JSON.stringify(
            {
                "username": userfield,
                "password": password,
                "serverkey": serverkey
            }),
            onAnswer
        );       

        return true;
    }
</script>


</body>
</html>
